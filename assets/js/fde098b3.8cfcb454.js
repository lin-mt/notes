"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[8616],{7145:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var a=r(4848),o=r(8453);const s={sidebar_position:1},l="Docker Compose \u90e8\u7f72",i={id:"dev-ops/pulsar/deploy/docker-compose",title:"Docker Compose \u90e8\u7f72",description:"\u73af\u5883\u51c6\u5907",source:"@site/docs/dev-ops/pulsar/deploy/docker-compose.md",sourceDirName:"dev-ops/pulsar/deploy",slug:"/dev-ops/pulsar/deploy/docker-compose",permalink:"/notes/docs/dev-ops/pulsar/deploy/docker-compose",draft:!1,unlisted:!1,editUrl:"https://github.com/lin-mt/notes/tree/main/docs/dev-ops/pulsar/deploy/docker-compose.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"devOpsPulsar",previous:{title:"\u7b80\u4ecb",permalink:"/notes/docs/dev-ops/pulsar/"},next:{title:"\u4f7f\u7528 JWT \u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1",permalink:"/notes/docs/dev-ops/pulsar/security/jwt"}},t={},c=[{value:"\u73af\u5883\u51c6\u5907",id:"\u73af\u5883\u51c6\u5907",level:2},{value:"\u51c6\u5907 docker-compose.yml \u6587\u4ef6",id:"\u51c6\u5907-docker-composeyml-\u6587\u4ef6",level:2},{value:"\u90e8\u7f72 Pulsar",id:"\u90e8\u7f72-pulsar",level:2},{value:"Pulsar Manager",id:"pulsar-manager",level:2},{value:"\u5378\u8f7d Pulsar",id:"\u5378\u8f7d-pulsar",level:2},{value:"\u95ee\u9898",id:"\u95ee\u9898",level:2},{value:"\u521b\u5efa tenant \u65f6\uff0cAllowed Cluster \u6ca1\u6709\u9009\u9879",id:"\u521b\u5efa-tenant-\u65f6allowed-cluster-\u6ca1\u6709\u9009\u9879",level:3},{value:"zookeeper \u542f\u52a8\u5931\u8d25",id:"zookeeper-\u542f\u52a8\u5931\u8d25",level:3},{value:"\u53c2\u8003\u5185\u5bb9",id:"\u53c2\u8003\u5185\u5bb9",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"docker-compose-\u90e8\u7f72",children:"Docker Compose \u90e8\u7f72"}),"\n",(0,a.jsx)(n.h2,{id:"\u73af\u5883\u51c6\u5907",children:"\u73af\u5883\u51c6\u5907"}),"\n",(0,a.jsx)(n.p,{children:"\u5b89\u88c5 Docker \u548c Docker Compose"}),"\n",(0,a.jsx)(n.h2,{id:"\u51c6\u5907-docker-composeyml-\u6587\u4ef6",children:"\u51c6\u5907 docker-compose.yml \u6587\u4ef6"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="docker-compose.yml"',children:'version: \'3\'\nnetworks:\n  pulsar:\n    driver: bridge\nservices:\n  # Start zookeeper\n  zookeeper:\n    image: apachepulsar/pulsar:3.1.1\n    container_name: zookeeper\n    restart: on-failure\n    networks:\n      - pulsar\n    volumes:\n      - ./data/zookeeper:/pulsar/data/zookeeper\n    environment:\n      - metadataStoreUrl=zk:zookeeper:2181\n      - PULSAR_MEM=-Xms256m -Xmx256m -XX:MaxDirectMemorySize=256m\n    command: >\n      bash -c "bin/apply-config-from-env.py conf/zookeeper.conf && \\\n             bin/generate-zookeeper-config.sh conf/zookeeper.conf && \\\n             exec bin/pulsar zookeeper"\n    healthcheck:\n      test: ["CMD", "bin/pulsar-zookeeper-ruok.sh"]\n      interval: 10s\n      timeout: 5s\n      retries: 30\n\n  # Init cluster metadata\n  pulsar-init:\n    container_name: pulsar-init\n    hostname: pulsar-init\n    image: apachepulsar/pulsar:3.1.1\n    networks:\n      - pulsar\n    command: >\n      bin/pulsar initialize-cluster-metadata \\\n               --cluster cluster-a \\\n               --zookeeper zookeeper:2181 \\\n               --configuration-store zookeeper:2181 \\\n               --web-service-url http://broker:8080 \\\n               --broker-service-url pulsar://broker:6650\n    depends_on:\n      zookeeper:\n        condition: service_healthy\n\n  # Start bookie\n  bookie:\n    image: apachepulsar/pulsar:3.1.1\n    container_name: bookie\n    restart: on-failure\n    networks:\n      - pulsar\n    environment:\n      - clusterName=cluster-a\n      - zkServers=zookeeper:2181\n      - metadataServiceUri=metadata-store:zk:zookeeper:2181\n      # otherwise every time we run docker compose uo or down we fail to start due to Cookie\n      # See: https://github.com/apache/bookkeeper/blob/405e72acf42bb1104296447ea8840d805094c787/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Cookie.java#L57-68\n      - advertisedAddress=bookie\n      - BOOKIE_MEM=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m\n    depends_on:\n      zookeeper:\n        condition: service_healthy\n      pulsar-init:\n        condition: service_completed_successfully\n    # Map the local directory to the container to avoid bookie startup failure due to insufficient container disks.\n    volumes:\n      - ./data/bookkeeper:/pulsar/data/bookkeeper\n    command: bash -c "bin/apply-config-from-env.py conf/bookkeeper.conf && exec bin/pulsar bookie"\n\n  # Start broker\n  broker:\n    image: apachepulsar/pulsar:3.1.1\n    container_name: broker\n    hostname: broker\n    restart: on-failure\n    networks:\n      - pulsar\n    environment:\n      - metadataStoreUrl=zk:zookeeper:2181\n      - zookeeperServers=zookeeper:2181\n      - clusterName=cluster-a\n      - managedLedgerDefaultEnsembleSize=1\n      - managedLedgerDefaultWriteQuorum=1\n      - managedLedgerDefaultAckQuorum=1\n      - advertisedAddress=broker\n      # \u5982\u679c\u4e0d\u662f\u5728\u672c\u5730\u5f00\u53d1\uff0c\u5219\u6b64\u5904\u7684 IP \u6539\u4e3a broker \u670d\u52a1\u5668\u6240\u5728\u7684 IP\n      - advertisedListeners=external:pulsar://127.0.0.1:6650\n      - PULSAR_MEM=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m\n    depends_on:\n      zookeeper:\n        condition: service_healthy\n      bookie:\n        condition: service_started\n    ports:\n      - "6650:6650"\n      - "8080:8080"\n    command: bash -c "bin/apply-config-from-env.py conf/broker.conf && exec bin/pulsar broker"\n  pulsar-manager:\n    image: apachepulsar/pulsar-manager:v0.4.0\n    container_name: pulsar-manager\n    ports:\n      - "9527:9527"\n      - "7750:7750"\n    volumes:\n      - ./manager:/manager\n    depends_on:\n      broker:\n        condition: service_started\n    networks:\n      - pulsar\n    environment:\n      SPRING_CONFIGURATION_FILE: /pulsar-manager/pulsar-manager/application.properties\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u90e8\u7f72-pulsar",children:"\u90e8\u7f72 Pulsar"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"docker compose up -d\n"})}),"\n",(0,a.jsx)(n.h2,{id:"pulsar-manager",children:"Pulsar Manager"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"\u521b\u5efa\u7ba1\u7406\u5458\u8d26\u53f7"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"CSRF_TOKEN=$(curl http://localhost:7750/pulsar-manager/csrf-token)\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'curl \\\n  -H \'X-XSRF-TOKEN: $CSRF_TOKEN\' \\\n  -H \'Cookie: XSRF-TOKEN=$CSRF_TOKEN;\' \\\n  -H "Content-Type: application/json" \\\n  -X PUT http://localhost:7750/pulsar-manager/users/superuser \\\n  -d \'{"name": "admin", "password": "pulsar", "description": "administrator account.", "email": "lin-mt@outlook.com"}\'\n'})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["\u4f7f\u7528\u7ba1\u7406\u5458\u8d26\u53f7\u767b\u9646 ",(0,a.jsx)(n.a,{href:"http://127.0.0.1:9527",children:"Pulsar Manager"})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"\u521b\u5efa Environment"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:r(147).A+"",width:"1122",height:"878"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u5378\u8f7d-pulsar",children:"\u5378\u8f7d Pulsar"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"docker compose down\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u95ee\u9898",children:"\u95ee\u9898"}),"\n",(0,a.jsx)(n.h3,{id:"\u521b\u5efa-tenant-\u65f6allowed-cluster-\u6ca1\u6709\u9009\u9879",children:"\u521b\u5efa tenant \u65f6\uff0cAllowed Cluster \u6ca1\u6709\u9009\u9879"}),"\n",(0,a.jsx)(n.p,{children:"\u4e0b\u8f7d pulsar \u547d\u4ee4\u884c\u5de5\u5177"}),"\n",(0,a.jsx)(n.admonition,{type:"warning",children:(0,a.jsx)(n.p,{children:"\u7248\u672c\u9700\u8981\u4e0e pulsar \u7248\u672c\u4fdd\u6301\u4e00\u81f4"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"wget https://archive.apache.org/dist/pulsar/pulsar-3.1.1/apache-pulsar-3.1.1-bin.tar.gz\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u89e3\u538b\u6587\u4ef6"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"tar xvfz apache-pulsar-3.1.1-bin.tar.gz && cd apache-pulsar-3.1.1\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u66f4\u65b0\u96c6\u7fa4\u4fe1\u606f"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"./bin/pulsar-admin clusters update cluster-a --url http://192.168.10.101:8080\n"})}),"\n",(0,a.jsx)(n.h3,{id:"zookeeper-\u542f\u52a8\u5931\u8d25",children:"zookeeper \u542f\u52a8\u5931\u8d25"}),"\n",(0,a.jsxs)(n.p,{children:["\u5c06\u670d\u52a1\u5668\u672c\u5730\u6302\u8f7d\u8def\u5f84\u7684\u6587\u4ef6\u5939\u6743\u9650\u6539\u4e3a",(0,a.jsx)(n.code,{children:"777"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"chmod 777 ./data/zookeeper\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"chmod 777 ./data/bookkeeper\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u53c2\u8003\u5185\u5bb9",children:"\u53c2\u8003\u5185\u5bb9"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://pulsar.apache.org/docs/3.1.x/getting-started-docker-compose/",children:"Run a Pulsar cluster locally with Docker Compose"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://pulsar.apache.org/docs/3.1.x/reference-cli-tools/",children:"Pulsar command-line tools"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://pulsar.apache.org/docs/3.1.x/administration-pulsar-manager/",children:"Pulsar Manager"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://github.com/apache/pulsar-manager/issues/292",children:"Manager doesn't show the Standalone cluster option for adding to tenant"})})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},147:(e,n,r)=>{r.d(n,{A:()=>a});const a=r.p+"assets/images/create_environment-8438a9d24a5fb6b5a7bbe199a7738bcd.png"}}]);